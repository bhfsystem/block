#!/usr/bin/env bash

#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile" || return 1

  main_clone "$@"
}

function main_clone {
  local tmp_list="$(mktemp -t XXXXXX)"
  if [[ "$#" == 0 ]]; then
    block list  > "$tmp_list"
  else
    for nm_block in "$@"; do
      echo "$nm_block"
    done > "$tmp_list"
  fi

  while read -r nm_block pth_block id_block; do
    if [[ -d "$pth_block" ]]; then
      continue
    fi

    local a="_clone_${nm_block//-/_}"
    if [[ -d "${!a:-}" ]]; then
      continue
    fi

    if [[ ! -d "$pth_block" ]]; then
      local url_git="$(app map "$nm_block")" # TODO get rid of app-map
      if [[ -n "$url_git" ]]; then
        git clone "$url_git" "$APP_PATH/$nm_block"
        pth_block="$APP_PATH/$nm_block"
        unset "$a"
      else
        echo "ERROR: could not find git repo for $nm_block" 1>&2
        break
      fi
    fi

    git clone "$url_git" "$APP_PATH/$nm_block"
    pth_block="$APP_PATH/$nm_block"

    read -r "$a" <<< "$pth_block"

    if [[ "$id_block" != "." ]]; then
      pushd "$pth_block"
      main_clone
      popd
    fi

  done < "$tmp_list"
  rm -f "$tmp_list"
}

source sub "$0" "$@"
