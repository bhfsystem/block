#!/usr/bin/env bash

#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile" || return 1

  local tmp_list="$(mktemp -t XXXXXX)"
  if [[ "$#" == 0 ]]; then
    block list  > "$tmp_list"
  else
    for nm_block in "$@"; do
      echo "$nm_block"
    done > "$tmp_list"
  fi

  while read -r nm_block pth_block id_block; do
    local a="_clone_${nm_block//-/_}"

    if [[ ! -d "$pth_block" ]]; then
      local url_git="$(app map "$nm_block")"
      if [[ -n "$url_git" ]]; then
        git clone "$url_git" "$APP_PATH/$nm_block"
        pth_block="$APP_PATH/$nm_block"
        unset "$a"
      else
        echo "ERROR: could not find git repo for $nm_block" 1>&2
        break
      fi
    fi

    if [[ "$id_block" != "." ]]; then
      if [[ "${!a:-}" != "$pth_block" ]]; then
        read -r "$a" <<< "$pth_block"
        export "$a"

        pushd "$pth_block"
        block clone
        popd
      fi
    fi
  done < "$tmp_list"
  rm -f "$tmp_list"
}

source sub "$0" "$@"
