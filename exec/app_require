#!/usr/bin/env bash

function source_pre {
  local pth_profiled
  set +f
  for pth_profiled in .profile.d/*.pre; do
    set -f
    if [[ -f "$pth_profiled" ]]; then
      source "$pth_profiled"
    fi
  done
}

function source_post {
  local pth_profiled
  set +f
  for pth_profiled in .profile.d/*.post; do
    set -f
    if [[ -f "$pth_profiled" ]]; then
      source "$pth_profiled"
    fi
  done
}

function require {
  local tmp_profile="$(mktemp -t XXXXXX)"

  local tmp_list="$(mktemp -t XXXXXX)"
  block list > "$tmp_list"

  while read -r nm_block pth_block id_block; do
    if [[ ! -d "$pth_block" ]]; then
      echo "ERROR: missing $nm_block block" 1>&2
      set --
      break
    fi

    source_pre
    if [[ -e "$pth_block/script/profile" ]]; then
      echo "source $pth_block/script/profile"
    fi
    if [[ -e "$pth_block/script/rc" ]]; then
      echo "source $pth_block/script/rc"
    fi
    source_post

  done < "$tmp_list" > "$tmp_profile"
  rm -f "$tmp_list"

  source "$tmp_profile"
  rm -f "$tmp_profile"
}

