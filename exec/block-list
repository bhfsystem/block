#!/usr/bin/ruby

require 'json'

def get_requires nm_block, info_block, reqs, ordered
  if File.exists? ".block-name"
    nm_block = File.read(".block-name").strip 
  end

  if reqs.member? nm_block
    return reqs
  end

  reqs[nm_block] = info_block

  reqs = if File.exists? "Blockfile.json"
    block = JSON.load(File.read("Blockfile.json"))
    block["require"].inject([]) {|acc, ele|
      acc += Array(ele)
    }.inject([]) {|acc, ele|
      git = if block["members"]
        if block["members"].members? ele
          block["members"][ele]
        end
      end || "git@github.com:defn/#{ele}"
      acc << [ ele, git ]
    }
  else
    []
  end.inject(reqs) {|acc, meh|
    ele, git = meh
    pth_dep = "#{ENV['BLOCK_PATH']}/#{ele}"
    Dir.chdir(pth_dep) do
      get_requires ele, {
          name: ele,
          path: pth_dep,
          git: git
        }, acc, ordered
    end
  }

  ordered << nm_block

  reqs
end

def main
  ordered = []
  reqs = get_requires(File.basename(Dir.pwd), {
      path: Dir.pwd,
      git: %x{git ls-remote --get-url}.strip,
      end: "."
    }, {}, ordered)
  ordered.each {|ele|
    puts "#{ele} #{reqs[ele][:path]} #{reqs[ele][:git]} #{reqs[ele][:end] || ""}"
  }
end

main
